#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "common.h"
#include "fooid.h"
//#include "sndfile.h"


#define SAMPLERRATE 44100
#define CHANNELS 	2 		//should consider nano, reduce time cost.
// in resample sub array 44100*2/2048 =43
// so SUB_SECONDS max is 40
#define SUB_SECONDS  10

int initFlag = 0;
t_fooid * fooid =NULL;
int centiseconds = 0;
int len = 0;
int result;
short * data =NULL;

//pcm array is input wav file's data 44100Hz
//num_samples is number of sample data pcm array
int fingerprint( short pcm[],int sampleRate, int numChannels,unsigned char buffer[] )
{

	int samplerrate = sampleRate;
	int channels = numChannels;

	 
	if( initFlag == 0 )
	{
		//initial t_fooid struct, reasample wav file to 8000hz.
		fooid = fp_init( samplerrate, channels );
	//    LOGD("fp_init() complete\n");
		initFlag = 1;
	}

	//len = (int)(channels * samplerrate / SUB_SECONDS); // every chip is 1s/SUB_SECONDS
	len = (int)(channels * samplerrate );
	data = malloc(sizeof(short) * len );

	//1/100 seconds
	//int items_read = channels *  samplerrate;
	centiseconds += (int)((len * 100 )/(channels * samplerrate)) ;
	//LOGD("ready to fp_short() ... \n");
	//printf("fingerprint: data size(len)=%d",len);

	/**
	*if 8000hz data (resample data) more than 100s, then return 0 (false).
	*if data is not enough, return 1;
	*if error, return -1;
	**/
	result = fp_feed_short( fooid, data, len );
	//LOGD("fp_feed_short() offset=%d, result=%d \n", offset, result);

	if ( result == 0)
	{
		//fp_size == 424
	    //unsigned char * buffer =  malloc(fp_getsize(fooid));
		 //   LOGD("fp_calculate() centiseconds=%d\n", centiseconds);
		//result = fp_calculate(fooid, centiseconds, buffer);
		fp_calculate(fooid, centiseconds, buffer);
		 //   LOGE("fp_calculate result= %d\n", result);
		//    LOGD("fp_calculate() complete\n");
	    fp_free(fooid);
	    free(data);
	    //   LOGD("free complete\n");
	}


	return result;
}
